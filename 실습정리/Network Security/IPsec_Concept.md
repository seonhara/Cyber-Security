# IPsec = IP Security
* 개념 : 네트워크 계층(IP 계층)에서 종단 노드 구간 또는 보안/터널 게이트웨이(Security/Tunnel Gateway) 구간에 **IP 패킷 보안 서비스를 제공해 주는 보안 프로토콜**
* **IPv6** : 기본으로 IPsec 포함
* 제공하는 보안서비스
  * 기밀성 - ESP 프로토콜이 암호화 지원
  * 비연결형 무결성
    - **메시지인증코드(MAC)** 를 통해 각 IP 패킷별로 무결성을 보장
    - 송신 측에서 인증 데이터(Authentication Data, MAC값)를 계산하여 전송하고 수신 측에서 이를 검증
  * 데이터 원천 인증/송신처 인증
    - **메시지인증코드(MAC)** 를 통해 IP 패킷이 올바른 송신처로부터 온 것임을 보장해 준다.
  * 재전송 공격 방지
    - 송신 측에서 **IP 패킷 별 순서번호(Sequence Number)를 전송**하고 수신 측에서 해당 보안연관(Security Association)에 순서번호를 유지하고 이를 검증함으로써 재전송 공격을 방지한다.
  * 접근 제어
    - **보안 정책(Security policy)** 을 통해 **송수신 IP 패킷에 대한 시스템 접근을 제어**한다.
    - 접근 제어 방식은 IP 패킷의 허용, 폐기, 보호(IPsec적용) 등이 있다. -> SPD(Security Policy Database)에 저장
  * 제한된 트래픽 흐름의 기밀성
    - ESP/터널모드의 경우 **원본 IP 헤더가 암호화**되어 있기에 **터널/보안 게이트웨이와 종단 노드 구간의 트래픽 흐름의 기밀성**은 보장된다.
    - New IP 헤더를 통해 **터널/보안 게이트웨이 구간의 트래픽 흐름 정보는 노출** 된다.
   
  ---
  ## IPsec 동작모드
  1. 전송모드
     * IP 패킷의 **페이로드를 IPsec으로 캡슐화하여 보호**하는 모드
     * IP 헤더를 보호하지 않아 트래픽 흐름이 분석될 수 있음
     * 목적: **종단 노드 구간의 IP 패킷 보호**
  2. 터널 모드
     * **IP 패킷 전체를 IPsec으로 캡슐화하여 보호**하는 모드
     * 제한적 트래픽 흐름의 기밀성 보장:
       * 최초 출발지 및 최종 목적지에 대한 트래픽 정보의 기밀성 보장
       * 전송 구간 정보를 담은 NewIP헤더가 추가됨
     * 목적: 터널/보안 게이트웨이 구간 또는 종단 노드와 터널/보안 게이트웨이 구간의 IP 패킷 보호를 위해 사용
---
## IPsec 세부 프로토콜
### AH 프로토콜
* **무결성과 송신처 인증만** 제공 =` 메시지를 평문으로 전송`
* 원리 : IP 헤더에 동적으로 변경되는 필드를 제외한 IP 패킷 전체를 대상으로 인증 데이터 계산
* 가변 필드 : TTL, Header Checksum, NAT 환경에서의 Source IP
* **동작모드**
  1. 전송모드 - **IP 헤더**의 전송 중 가변 필드를 제외한 IP 패킷 전체 인증
  2. 터널모드 - **New IP 헤더**의 전송 중 가변 필드를 제외한 New IP 패킷 전체를 인증

### ESP 프로토콜
* **무결성, 송신처 인증, 기밀성** 제공
* 원리 : 메시지인증코드(MAC), 암호화 이용 = `메시지 암호화 전송`
* ESP VS AH: AH는 가변 IP 헤더 필드를 제외한 IP 패킷 전체를 인증하나 ESP는 IP 헤더를 인증하지 않음
* **동작모드**
  1. 전송모드 - **IP 페이로드와 ESP 트레일러**를 암호화하고 암호화된 데이터와 ESP 헤더를 인증
  2. 터널모드 - **원본 IP 패킷 전체와 ESP 트레일러**를 암호화하고 암호화된 데이터와 ESP 헤더를 인증
 
#### 보안연관(SA: Security Association)
* 개념: 두 호스트 사이에 논리적인 연결 상태를 유지하는 동안 적용할 보안 설정 정보
* 특징: 단방향성/일방향성
* 대상 호스트와 송수신을 위해 *보안연관 2개 필요*
* SAD(Security Association Database): 보안연관을 저장해두는 데이터 베이스

